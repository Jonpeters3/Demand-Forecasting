---
title: "Demand_Forcasting"
author: "Jon Peters"
date: "10/30/2020"
output: html_document
---

```{r}
library(tidyverse)
library(caret)
library(forecast)
train <- read_csv("train.csv")
test <- read_csv("test.csv")
numStores <- unique(train$store)
numItems <- unique(train$item)





numStores <- unique(train$store)
numItems <- unique(train$item)

ggplot(train, mapping = aes(x=date, y=sales, color = as.factor(store))) + geom_point() + theme_classic()
```

```{r}
for (i in numStores){
    for (j in numItems){
        temp_df <- data.frame()
        t <- Arima((train %>% filter(store == i, item == j))$sales, order = c(0, 2, 2), seasonal = c(0, 0, 0))
        
        f <- Arima((test %>% filter(store == i, item == j))$date, model = t)
        
        temp_df <- cbind(Id = (test %>% filter(store == i, item == j))$id, x = as.data.frame(as.double(f$fitted)))
        
        finalDF <- rbind(finalDF, temp_df)
    }
}
colnames(finalDF) <- c("Id", "sales")

write_csv(finalDF, "submission.csv")
```

```{r}
train <- train %>% mutate(dayOfWeek = weekdays(date),
                          year = lubridate::year(date), 
                          month = lubridate::month(date),
                          day = lubridate::day(date)) %>% select(-date)

test <- test %>% mutate(dayOfWeek = weekdays(date),
                        year = lubridate::year(date),
                        month = lubridate::month(date),
                        day = lubridate::day(date)) %>% select(-date)
```

```{r}
finalDF <- data.frame()

tune.grid <- expand.grid(n.trees = seq(200, 600, 25),
                         interaction.depth = c(1, 2),
                         n.minobsinnode = 10,
                         shrinkage = .1)


#for (i in numStores){
    
    for (j in numItems){
        temp_df <- data.frame()
        
        linreg <- train(form=sales~., 
                data=(train %>% filter(item == j) %>% select(-item)),
                method = "gbm",
                tuneGrid =tune.grid,
                trControl=trainControl(method="repeatedcv",
                                       number=5,
                                       repeats = 3),
                verbose = FALSE
                )
        
        
        temp_df <- data.frame(Id= (test %>% filter(item == j) %>% select(id)), sales = predict(linreg, newdata = test %>% filter(item == j) %>% select(-id)))

        finalDF <- rbind(finalDF, temp_df)
    }
#}
colnames(finalDF) <- c("Id", "sales")

write_csv(finalDF, "submission.csv")

finalDF
```





















```{r}
summary(train)
#No missing values!
```

```{r}
fit <- auto.arima(ts(train[, 4]))


forecast(fit)
```

